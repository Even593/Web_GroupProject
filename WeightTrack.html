<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Weight Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      /* Updated background image */
      background-image: url(./fitness_weight.jpg);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .overlay {
      background-color: rgba(255, 255, 255, 0.85);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="container mt-5 overlay">
    <h2 class="mb-4 text-center">Weight Management</h2>

    <!-- Record input form -->
    <div class="card mb-4">
      <div class="card-body">
        <form id="weightForm" class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="date" class="form-label">Date</label>
            <input type="date" class="form-control" id="date" required>
          </div>
          <div class="col-md-4">
            <label for="weight" class="form-label">Weight (kg)</label>
            <input type="number" step="0.1" class="form-control" id="weight" placeholder="e.g., 65.2" required>
          </div>
          <div class="col-md-4 d-grid">
            <button type="button" class="btn btn-primary" onclick="add()">Add Record</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Health status display -->
    <div id="status" class="alert alert-info text-center fs-5" style="display:none;"></div>

    <!-- Goal progress widget -->
    <div class="row mb-4">
      <div class="col">
        <div class="card">
          <div class="card-header">Goal Progress</div>
          <div class="card-body">
            <p>Target Weight: <span id="goalWeightDisplay">--</span> kg</p>
            <div class="progress">
              <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"
                   aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Weight trend chart -->
      <div class="col-lg-8 mb-4">
        <div class="card">
          <div class="card-header">Weight Trend</div>
          <div class="card-body">
            <canvas id="chart"></canvas>
          </div>
        </div>
      </div>

      <!-- History records table -->
      <div class="col-lg-4 mb-4">
        <div class="card">
          <div class="card-header">History Records</div>
          <div class="card-body p-0">
            <table class="table table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Date</th>
                  <th scope="col">Weight (kg)</th>
                </tr>
              </thead>
              <tbody id="recordTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const userId = 1;  // Example user ID

    // Fetch data from backend and render UI
    async function fetchData() {
      const res = await fetch(`/api/weights?userId=${userId}`);
      // Expecting backend to return { records, bmi, status, goalWeight }
      const { records, bmi, status, goalWeight } = await res.json();

      // Display health status
      const statusEl = document.getElementById('status');
      if (bmi) {
        statusEl.style.display = 'block';
        statusEl.textContent = `Current BMI: ${bmi}, Health Status: ${status}`;
      } else {
        statusEl.style.display = 'none';
      }

      // Render history table
      const tbody = document.getElementById('recordTable');
      tbody.innerHTML = records.map(r =>
        `<tr><td>${r.date}</td><td>${r.weight}</td></tr>`
      ).join('');

      // Update goal progress
      const goalDisplay = document.getElementById('goalWeightDisplay');
      const progressBar = document.getElementById('progressBar');
      if (goalWeight && records.length > 0) {
        goalDisplay.textContent = goalWeight;
        const initialWeight = records[0].weight;
        const latestWeight = records[records.length - 1].weight;
        let percent = ((initialWeight - latestWeight) / (initialWeight - goalWeight)) * 100;
        percent = Math.max(0, Math.min(percent, 100));
        progressBar.style.width = `${percent.toFixed(1)}%`;
        progressBar.setAttribute('aria-valuenow', percent.toFixed(1));
        progressBar.textContent = `${percent.toFixed(1)}%`;
      } else {
        goalDisplay.textContent = '--';
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', '0');
        progressBar.textContent = '0%';
      }

      // Render weight trend chart
      const ctx = document.getElementById('chart').getContext('2d');
      if (window.weightChart) window.weightChart.destroy();
      window.weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: records.map(r => r.date),
          datasets: [{
            label: 'Weight (kg)',
            data: records.map(r => r.weight),
            fill: false,
            tension: 0.3,
            borderWidth: 2
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Date' } },
            y: { title: { display: true, text: 'Weight (kg)' } }
          }
        }
      });
    }

    // Add a new weight record
    async function add() {
      const date = document.getElementById('date').value;
      const weight = parseFloat(document.getElementById('weight').value);
      if (!date || !weight) return;

      await fetch('/api/weights', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, record_date: date, weight_kg: weight })
      });
      // Reset form and reload data
      document.getElementById('weightForm').reset();
      fetchData();
    }

    // Initialize page
    fetchData();
  </script>
</body>
</html>
